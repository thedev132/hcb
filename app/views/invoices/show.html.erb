<% title "Invoice to #{@invoice.sponsor.name.html_safe} for #{render_money @invoice.total}" %>
<% page_md %>
<% include_modals %>
<%= render 'events/nav' %>

<% admin_tools('mt3') do %>
  <%= link_to 'Manually mark as paid', invoice_manual_payment_path(@invoice), class: 'btn bg-success mr2' unless @invoice.paid? %>
  <%= link_to 'View on Stripe', @invoice.stripe_dashboard_url, class: 'btn bg-accent' %>
<% end %>

<% admin_tools do %>
  <%= link_to "#{render_money @invoice.payout.t_transaction.amount} payout TX", @invoice.payout.t_transaction if @invoice&.payout&.t_transaction %>
  <%= link_to "#{render_money @invoice.fee_reimbursement.t_transaction.amount} fee refund TX", @invoice.fee_reimbursement.t_transaction if @invoice&.fee_reimbursement&.t_transaction %>
<% end %>

<% if @invoice.archived? %>
  <div class="banner banner--archived mt3">
    <span class="bold block mb1">This invoice was archived by <%= user_mention @invoice.archived_by %> on <%= format_date @invoice.archived_at %>.</span>
    <span class="block">It will only display in the Archived tab<span class="xs-hide"> on the Invoices page</span>.</span>
    <span>You can <%= link_to 'un-archive it', invoice_unarchive_path(@invoice), method: :post %>.</span>
  </div>
<% end %>

<article class="card pb0 mt3 mb3">
  <h2 class="h2 mt0 mx0 border-none flex items-center justify-between">
    <span>
      <%= @sponsor.name %>
      <span class="regular muted"> invoiced for </span>
      <span class="regular"><%= render_money @invoice.item_amount %></span>
    </span>
    <span class="badge h4 md-right bg-<%= @invoice.state %>">
      <%= @invoice.state_text %>
      <%= inline_icon @invoice.state_icon, size: 20 if @invoice.state_icon %>
    </span>
  </h2>
  <section class="card__banner card__darker details-horiz border-top border-bottom">
    <p>
      <strong>Sent by</strong>
      <%= user_mention @invoice.creator %>
    </p>
    <p>
      <strong>Sent at</strong>
      <%= invoice_sent_at %>
    </p>
  </section>
  <!-- recipient info -->
  <section class="details details--wide pt2 pb2 details--tall">
    <% unless %w[Paid Pending].include? @invoice.state_text %>
      <p>
        <strong>Due date</strong>
        <span>
          <%= format_date @invoice.due_date %>
          <span class="muted">
            <% if @invoice.due_date > Time.now %>
              (in <%= distance_of_time_in_words @invoice.due_date, Time.now %>)
            <% else %>
              (<%= distance_of_time_in_words @invoice.due_date, Time.now %> ago)
            <% end %>
          </span>
        </span>
      </p>
    <% end %>
    <p>
      <strong>Billed to</strong>
      <% if organizer_signed_in? %>
        <span><%= mail_to @invoice.sponsor.contact_email.downcase %></span>
      <% else %>
        <span><strong>Sign in to view</strong></span>
      <% end %>
    </p>
    <p>
      <strong>Payment methods</strong>
      <span class="flex">
        <span class="bg-smoke slate tooltipped tooltipped--s inline-flex rounded mr2" aria-label="Credit or debit cards" style="padding: 4px;">
          <%= inline_icon 'card', size: 24 %>
        </span>
        <span class="bg-smoke slate tooltipped tooltipped--s inline-flex rounded" aria-label="ACH credit transfers and domestic wires">
          <%= inline_icon 'bank-account', size: 32 %>
        </span>
      </span>
    </p>
    <p>
      <strong>Address</strong>
      <% if organizer_signed_in? %>
        <span>
        <%= @sponsor.address_line1 %><br />
        <% if @sponsor.address_line2.present? %>
          <%= @sponsor.address_line2 %><br />
        <% end %>
        <%= @sponsor.address_city %>, <%= @sponsor.address_state %> <%= @sponsor.address_postal_code %>
        </span>
      <% else %>
        <span><strong>Sign in to view</strong></span>
      <% end %>
    </p>
    <p>
      <strong>Memo</strong>
      <span><%= @invoice.memo %></span>
    </p>
  </section>
  <section class="card__banner card__darker details details--wide border-top md-pl0 md-pr0">
    <table>
    <thead>
      <tr>
        <td>Description</td>
        <td>Amount</td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="white-space: normal"><%= @invoice.item_description %></td>
        <td><%= render_money @invoice.item_amount %></td>
      </tr>
      <tr class="border-none">
        <td class="right-align pr1"><strong>Total</strong></td>
        <td><strong><%= render_money @invoice.item_amount %></strong></td>
      </tr>
    </tbody>
    </table>
  </section>

  <section class="card__banner border-top flex flex-wrap">
    <div class="btn-group mr-auto">
    <%= link_to organizer_signed_in? ? @invoice.hosted_invoice_url : root_path,
      disabled: !organizer_signed_in?,
      class: 'btn bg-accent mr1',
      target: '_blank' do %>
      <%= inline_icon 'external' %>
      View sent invoice
    <% end %>
    <%= link_to organizer_signed_in? ? @invoice.invoice_pdf : root_path,
      disabled: !organizer_signed_in?,
      class: 'btn bg-info mr1',
      target: '_blank' do %>
      <%= inline_icon 'download' %>
      PDF
    <% end %>
    </div>
    <%= link_to "#{@invoice.archived? ? 'Un-archive' : 'Archive'}",
      (@invoice.archived? ? invoice_unarchive_path(@invoice) : invoice_archive_path(@invoice)),
      disabled: !organizer_signed_in?,
      method: :post,
      class: 'btn bg-muted'
    %>
  </section>
</article>

<% if %w[Paid Pending].include? @invoice.state_text %>
<article class="card pb0 mt3 mb3">
  <h2 class="h2 mt0 border-none">
    <%= @sponsor.name %>
    <span class="regular muted"> paid </span>
    <span class="regular"><%= render_money @invoice.item_amount %></span>
  </h2>
  <section class="card__banner card__darker details-horiz border-top border-bottom">
    <% if @invoice.payment_method_type == 'card' %>
      <action data-behavior="modal_trigger" data-modal="payment_details" class="details-horiz__col pointer" tabindex="0">
        <strong>
          <%# Nested tag to avoid flexbox-induced full-width strong leading to icon on right edge on mobile %>
          <span class="inline-flex items-start relative" style="padding-right: 28px;">
            Payment method
            <%= inline_icon 'external', size: 24, class: 'muted ml1 absolute right-0', 'aria-label': 'Icon indicating click for more' %>
          </span>
        </strong>
        <span class="inline-flex">
          <%= invoice_payment_method_mention %>
        </span>
      </action>
    <% else %>
      <p>
        <strong>Payment method</strong>
        <span class="inline-flex">
          <%= invoice_payment_method_mention %>
        </span>
      </p>
    <% end %>
    <p>
      <strong>Paid at</strong>
      <%= invoice_paid_at %>
    </p>
    <%= invoice_payout_datetime %>
  </section>
  <% if @invoice.manually_marked_as_paid? %>
    <section class="mt2 mb1">
      <div>
        <p>
          This invoice was manually marked as paid by <%= @invoice.manually_marked_as_paid_user.full_name %>.
        </p>
        <p>
          Reason given: "<%= @invoice.manually_marked_as_paid_reason %>"
        </p>
        <% if @invoice.manually_marked_as_paid_attachment.attached? %>
          <p><%= link_to 'Download provided attachment', @invoice.manually_marked_as_paid_attachment if organizer_signed_in? %></p>
        <% end %>
      </div>
      <div class="details">
      <%= invoice_payout_datetime %>
      </div>
    </section>
  <% elsif @invoice.payout %>
    <section class="pt2 pb2 details">
      <p>
        <strong>Recipient email</strong>
        <% if organizer_signed_in? %>
          <%= mail_to @sponsor.contact_email, @sponsor.contact_email.downcase, class: 'slate underline' %>
        <% else %>
          <strong>Sign in to view</strong>
        <% end %>
      </p>
      <p>
        <strong>Amount</strong>
        +<%= render_money @invoice.item_amount %>
      </p>
      <p>
        <strong><%= invoice_fee_type %></strong>
        -<%= invoice_payment_processor_fee %>
      </p>
      <p>
        <strong>Processing fee refund</strong>
        <span>
          +<%= invoice_payment_processor_fee %>
          <span class="muted">
            <% 'Pending ' unless @invoice&.fee_reimbursement&.t_transaction %>
            (<%= link_to 'learn more', "https://headwayapp.co/bank-changelog/we're-making-payment-processing-fees-disappear-101088" %>)
          </span>
        </span>
      </p>
    </section>
    <%# if @invoice.payment_method_type == 'ach_credit_transfer' %>
  <% end %>
</article>
<% end %>

<% if @invoice.payment_method_type == 'card' %>
  <section class="modal modal--scroll bg-snow" data-behavior="modal" role="dialog" id="payment_details">
    <%= modal_header 'Payment details' + content_tag(:span, '', class: 'pl2') + invoice_payment_method_mention(@invoice, class: 'h3 sans slate regular') %>

    <article class="details-horiz">
      <div class="details">
        <p>
          <strong>Payment type</strong>
          <%= @invoice.payment_method_card_funding.humanize.capitalize %>
        </p>
        <p>
          <strong>Brand</strong>
          <%= @invoice.payment_method_card_brand.humanize.capitalize %>
        </p>
        <p>
          <strong>Expiration</strong>
          <% if organizer_signed_in? %>
            <%= @invoice.payment_method_card_exp_month.to_s.rjust(2, '0') %> / <%= @invoice.payment_method_card_exp_year %>
          <% else %>
            MM / YYYY (Sign in to view)
          <% end %>
        </p>
      </div>
      <div class="mt1 md-mt0">
        <p class="details__simulated">
          <%= invoice_card_country_mention %>
          <span>Payment country</span>
        </p>
        <p class="details__simulated">
          <%= invoice_card_check_badge 'cvc' %>
          <span>CVC check</span>
        </p>
        <p class="details__simulated">
          <%= invoice_card_check_badge 'address_postal_code' %>
          <span>Zip check</span>
        </p>
      </div>
    </article>
  </section>
<% end %>

<%= render 'comments/comments' %>

<%= render partial: 'admin_viewer', locals: { record: @invoice } %>